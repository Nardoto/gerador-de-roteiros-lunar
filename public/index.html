<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Roteiros - Teste Local</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #764ba2;
            margin-bottom: 30px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }

        .input-section, .output-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .output-section {
            max-height: calc(100vh - 120px);
        }

        h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #333;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            min-height: 400px;
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .message.user {
            background: #e3f2fd;
            border-left-color: #2196F3;
        }

        .message.assistant {
            background: #f3e5f5;
            border-left-color: #9C27B0;
        }

        .message.system {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .message.error {
            background: #ffebee;
            border-left-color: #f44336;
        }

        .message-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.85rem;
        }

        .message-content {
            white-space: pre-wrap;
            font-size: 0.75rem;
            line-height: 1.4;
            color: #444;
            max-height: 200px;
            overflow-y: auto;
        }

        .message-stats {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(0,0,0,0.05);
            border-radius: 6px;
            font-size: 0.85rem;
            color: #666;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .message-stats span {
            font-weight: 600;
        }

        .prompt-toggle {
            margin-top: 8px;
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .prompt-toggle:hover {
            background: #5568d3;
        }

        .prompt-content {
            display: none;
            margin-top: 10px;
            padding: 12px;
            background: #f0f0f0;
            border-left: 3px solid #667eea;
            border-radius: 6px;
            font-size: 0.85rem;
            white-space: pre-wrap;
            color: #333;
            max-height: 300px;
            overflow-y: auto;
        }

        .prompt-content.visible {
            display: block;
        }

        .progress {
            margin-top: 15px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            color: #1976D2;
            display: none;
        }

        .downloads {
            margin-top: 20px;
            display: none;
        }

        .download-btn {
            margin-bottom: 10px;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: block;
            width: 100%;
            text-align: left;
            font-weight: 600;
        }

        .download-btn:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="margin: 0;">üé¨ Gerador de Roteiros - Teste Local</h1>
            <button id="logoutBtn" style="padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                üö™ Sair
            </button>
        </div>

        <div class="grid">
            <!-- Inputs -->
            <div class="input-section">
                <h2>üìù Configura√ß√µes</h2>

                <label>T√≠tulo do V√≠deo:</label>
                <input type="text" id="title" value="A Vida de Davi" placeholder="Ex: A Vida de Mois√©s">

                <label>Sinopse:</label>
                <textarea id="synopsis" placeholder="Descreva resumidamente o tema...">Como era Davi como Pai, ser√° que ele como homem segundo cora√ß√£o de Deus foi um bom pai?</textarea>

                <label>Base de Conhecimento (opcional):</label>
                <textarea id="knowledge" placeholder="Informa√ß√µes adicionais..."></textarea>

                <label>üåç Idioma do Roteiro:</label>
                <select id="language" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95rem;">
                    <option value="pt" selected>üáßüá∑ Portugu√™s</option>
                    <option value="en">üá∫üá∏ English (Ingl√™s)</option>
                    <option value="es">üá™üá∏ Espa√±ol (Espanhol)</option>
                </select>

                <div class="input-row">
                    <div>
                        <label>T√≥picos:</label>
                        <input type="number" id="numTopics" value="3" min="1" max="10">
                    </div>
                    <div>
                        <label>Subt√≥picos:</label>
                        <input type="number" id="numSubtopics" value="8" min="1" max="20">
                    </div>
                    <div>
                        <label>Caracteres Hook:</label>
                        <input type="number" id="hookChars" value="1000" step="100">
                    </div>
                </div>

                <label>Caracteres Totais:</label>
                <input type="number" id="totalChars" value="20000" step="1000">

                <label>Modelo Claude (para roteiro):</label>
                <select id="claudeModel" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95rem;">
                    <option value="claude-sonnet-4-5-20250929">Claude Sonnet 4.5 (Recomendado - Melhor para C√≥digo)</option>
                    <option value="claude-sonnet-4-20250514">Claude Sonnet 4 (R√°pido e Barato)</option>
                    <option value="claude-opus-4-1-20250805">Claude Opus 4.1 (Melhor Qualidade)</option>
                    <option value="claude-haiku-4-5">Claude Haiku 4.5 (Mais R√°pido)</option>
                </select>

                <!-- Configura√ß√£o de Blocos -->
                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #FF9800;">
                    <label style="font-weight: bold; color: #FF9800; margin-bottom: 8px; display: block;">üìê Configura√ß√£o de Divis√£o em Blocos:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 0.85rem;">Caracteres por Bloco:</label>
                            <input type="number" id="blockCharsConfig" value="490" min="80" max="500" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="font-size: 0.85rem;">Reading Rate (c/s):</label>
                            <input type="number" id="readingRateConfig" value="12" min="5" max="30" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                </div>

                <!-- Modo Autom√°tico -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <label style="color: white; display: flex; align-items: center; cursor: pointer; font-size: 16px; font-weight: bold;">
                        <input type="checkbox" id="modoAutomaticoInicio" style="margin-right: 10px; width: 20px; height: 20px; cursor: pointer;">
                        üöÄ MODO AUTOM√ÅTICO - Gera roteiro + documentos
                    </label>
                    <div id="configAutomatico" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3);">
                        <label style="color: white; display: block; margin-bottom: 5px; font-size: 13px;">‚öôÔ∏è Modelo para Documentos (Trilha + Personagens):</label>
                        <select id="modeloDocumentosInicio" style="padding: 8px; border-radius: 6px; border: none; font-size: 14px; width: 100%; margin-bottom: 10px;">
                            <option value="claude-sonnet-4-20250514" selected>Sonnet 4 (mais barato)</option>
                            <option value="claude-sonnet-4-5-20250929">Sonnet 4.5</option>
                            <option value="claude-haiku-4-5">Haiku 4.5 (muito r√°pido)</option>
                        </select>

                        <label style="color: white; display: block; margin-bottom: 5px; font-size: 13px;">üé¨ Modelo para Takes (Prompts de Imagem):</label>
                        <select id="modeloTakesInicio" style="padding: 8px; border-radius: 6px; border: none; font-size: 14px; width: 100%;">
                            <option value="claude-sonnet-4-20250514" selected>Sonnet 4 (mais barato)</option>
                            <option value="claude-sonnet-4-5-20250929">Sonnet 4.5 (recomendado)</option>
                            <option value="claude-haiku-4-5">Haiku 4.5 (muito r√°pido)</option>
                        </select>

                        <div style="color: #fff3cd; font-size: 12px; margin-top: 8px;">
                            ‚è±Ô∏è Tempo estimado: ~3-5 minutos | Custo: ~$0.80-$1.00
                        </div>
                    </div>
                </div>

                <button id="generateBtn" style="font-size: 16px; padding: 15px; font-weight: bold;">
                    <span id="generateBtnText">üöÄ Gerar Roteiro</span>
                </button>

                <div class="progress" id="progress">
                    <span id="progressText">Gerando...</span>
                    <span id="timer" style="display: none; margin-left: 10px; font-weight: bold;">‚è±Ô∏è 0:00</span>

                    <!-- Barra de Progresso Visual -->
                    <div style="width: 100%; background: #e0e0e0; border-radius: 10px; margin-top: 15px; height: 30px; overflow: hidden;">
                        <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                            <span id="progressPercent">0%</span>
                        </div>
                    </div>

                    <!-- Contadores de Caracteres -->
                    <div id="charCounters" style="display: none; margin-top: 15px; padding: 12px; background: #e3f2fd; border-radius: 8px; font-size: 0.85rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <strong>üìù Roteiro:</strong>
                                <div id="roteiroChars" style="font-size: 1.1rem; font-weight: bold; color: #1976D2;">0 caracteres</div>
                            </div>
                            <div>
                                <strong>üì¶ Total (com docs):</strong>
                                <div id="totalCharsDisplay" style="font-size: 1.1rem; font-weight: bold; color: #388E3C;">0 caracteres</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Outputs -->
            <div class="output-section">
                <h2>üí¨ Conversa com IA</h2>
                <div class="messages" id="messages">
                    <div class="message system">
                        <div class="message-label">Sistema</div>
                        <div class="message-content">Preencha os campos e clique em "Gerar Roteiro"</div>
                    </div>
                </div>

                <div class="downloads" id="downloads">
                    <h2>üì• Downloads</h2>

                    <!-- Bot√£o Principal -->
                    <button id="downloadTudo" class="download-btn" style="background: linear-gradient(135deg, #00e676 0%, #00c853 100%); color: #000; font-size: 16px; font-weight: bold; padding: 15px; margin-bottom: 10px;">
                        üì¶ BAIXAR TODOS OS DOCUMENTOS
                    </button>

                    <!-- Bot√£o JSON -->
                    <button id="downloadJSON" class="download-btn" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; font-size: 14px; font-weight: bold; padding: 12px; margin-bottom: 15px;">
                        üìã BAIXAR JSON (Documenta√ß√£o Completa)
                    </button>

                    <!-- Bot√µes Individuais -->
                    <button class="download-btn" id="downloadEstrutura">üìã Baixar Estrutura</button>
                    <button class="download-btn" id="downloadHook">üé£ Baixar Hook</button>
                    <button class="download-btn" id="downloadTopico1">üìñ Baixar T√≥pico 1</button>
                    <button class="download-btn" id="downloadTopico2">üìñ Baixar T√≥pico 2</button>
                    <button class="download-btn" id="downloadTopico3">üìñ Baixar T√≥pico 3</button>
                    <button class="download-btn" id="downloadCompleto">üìù Baixar Roteiro Completo</button>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Import de Blocos (sempre vis√≠vel) -->
        <div class="container" style="margin-top: 30px;">
            <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); padding: 20px; border-radius: 12px;">
                <h2 style="color: white; margin-top: 0;">üì§ Importar Blocos e Gerar Takes</h2>
                <p style="color: rgba(255,255,255,0.9); margin-bottom: 15px; font-size: 14px;">
                    Fa√ßa upload do arquivo <strong>blocos.txt</strong> para gerar apenas os takes, sem precisar gerar o roteiro novamente.
                </p>

                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
                    <div>
                        <label style="color: white; display: block; margin-bottom: 8px; font-weight: bold;">üìÑ Arquivo blocos.txt:</label>
                        <input type="file" id="blocosFileInput" accept=".txt" style="padding: 10px; border-radius: 6px; border: 2px solid white; background: white; width: 100%; font-size: 14px;">
                    </div>

                    <div>
                        <label style="color: white; display: block; margin-bottom: 8px; font-weight: bold;">üë• Personagens (opcional):</label>
                        <input type="file" id="personagensFileInput" accept=".txt" style="padding: 10px; border-radius: 6px; border: 2px solid white; background: white; width: 100%; font-size: 14px;">
                        <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 4px;">Se n√£o enviar, aparecer√° "[Personagem n√£o encontrado]"</div>
                    </div>

                    <div>
                        <label style="color: white; display: block; margin-bottom: 8px; font-weight: bold;">‚öôÔ∏è Modelo:</label>
                        <select id="modeloTakesImport" style="padding: 10px; border-radius: 6px; border: none; font-size: 14px; width: 200px;">
                            <option value="claude-sonnet-4-20250514" selected>Sonnet 4 (mais barato)</option>
                            <option value="claude-sonnet-4-5-20250929">Sonnet 4.5 (recomendado)</option>
                            <option value="claude-opus-4-1-20250805">Opus 4.1 (melhor qualidade)</option>
                            <option value="claude-haiku-4-5">Haiku 4.5 (mais r√°pido)</option>
                        </select>
                    </div>
                </div>

                <button id="importBlocosBtn" class="download-btn" disabled style="background: #00e676; color: #000; font-size: 16px; font-weight: bold; padding: 15px; margin-top: 15px; width: 100%;">
                    üé¨ GERAR TAKES A PARTIR DOS BLOCOS
                    <div style="font-size: 12px; font-weight: normal; margin-top: 5px;">Custo: ~$0.08 (depende do n√∫mero de blocos)</div>
                </button>

                <!-- Status Import -->
                <div id="importStatus" style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 8px; color: white; display: none;">
                    <strong>‚è≥ Status:</strong>
                    <div id="importStatusText" style="margin-top: 8px; margin-bottom: 12px;"></div>

                    <!-- Barra de Progresso -->
                    <div style="width: 100%; background: rgba(255,255,255,0.3); border-radius: 10px; height: 30px; overflow: hidden;">
                        <div id="importProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #00e676 0%, #00c853 100%); transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                            <span id="importProgressPercent">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ferramentas de Manipula√ß√£o -->
        <div id="tools" class="container" style="display: none; margin-top: 30px;">
            <h1>üõ†Ô∏è Ferramentas de Manipula√ß√£o</h1>

            <!-- Se√ß√£o de IA -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h2 style="color: white; margin-top: 0;">ü§ñ Gera√ß√£o com IA</h2>

                <!-- Configura√ß√µes -->
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; margin-bottom: 15px; align-items: center;">
                    <div>
                        <label style="color: white; display: block; margin-bottom: 5px; font-weight: bold;">‚öôÔ∏è Modelo para Documentos:</label>
                        <select id="modeloDocumentos" style="padding: 8px; border-radius: 6px; border: none; font-size: 14px; width: 100%;">
                            <option value="claude-sonnet-4-20250514" selected>Sonnet 4 (mais barato)</option>
                            <option value="claude-sonnet-4-5-20250929">Sonnet 4.5 (recomendado)</option>
                        </select>
                    </div>

                    <div style="text-align: right;">
                        <label style="color: white; display: block; margin-bottom: 5px; font-weight: bold; cursor: pointer;">
                            <input type="checkbox" id="modoAutomatico" style="margin-right: 5px; width: 18px; height: 18px; vertical-align: middle; cursor: pointer;">
                            üöÄ Modo Autom√°tico
                        </label>
                        <span style="color: rgba(255,255,255,0.8); font-size: 11px; display: block;">Gera tudo em sequ√™ncia</span>
                    </div>
                </div>

                <!-- Bot√£o Autom√°tico (s√≥ aparece se modo autom√°tico estiver ativo) -->
                <div id="btnAutomaticoContainer" style="display: none; margin-bottom: 15px;">
                    <button id="gerarTodosBtn" class="download-btn" style="background: #00e676; color: #000; font-size: 16px; font-weight: bold; padding: 15px;">
                        üöÄ GERAR TODOS OS DOCUMENTOS (~45s)
                        <div style="font-size: 12px; font-weight: normal; margin-top: 5px;">Trilha + Personagens + Takes | Custo: ~$0.12</div>
                    </button>
                </div>

                <!-- Bot√µes Individuais -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <button id="gerarTrilhaBtn" class="download-btn" style="background: #9c27b0;">üéµ Gerar Trilha Sonora</button>
                    <button id="gerarPersonagensBtn" class="download-btn" style="background: #e91e63;">üë• Gerar Personagens</button>
                    <button id="gerarTakesBtn" class="download-btn" style="background: #f44336;" disabled title="Gere os personagens primeiro">üé¨ Gerar Takes</button>
                </div>

                <!-- Status -->
                <div id="aiStatus" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px; color: white; display: none;">
                    <strong>‚è≥ Status:</strong>
                    <div id="aiStatusText"></div>
                </div>
            </div>

            <div class="grid">
                <!-- Config da divis√£o -->
                <div class="input-section">
                    <h2>‚öôÔ∏è Configura√ß√µes</h2>

                    <div class="input-row">
                        <div>
                            <label>Caracteres por Bloco:</label>
                            <input type="number" id="blockChars" value="490" min="100" max="500">
                        </div>
                        <div>
                            <label>Palavras por Bloco:</label>
                            <input type="number" id="blockWords" value="17" min="5" max="100">
                        </div>
                        <div>
                            <label>Reading Rate (c/s):</label>
                            <input type="number" id="readingRate" value="12" min="5" max="30">
                        </div>
                    </div>

                    <button id="divideByCharsBtn" class="download-btn" style="background: #FF9800;">üìê Dividir por Caracteres</button>
                    <button id="divideByWordsBtn" class="download-btn" style="background: #FF9800; margin-top: 10px;">üìù Dividir por Palavras</button>
                    <button id="exportSrtBtn" class="download-btn" style="background: #2196F3; margin-top: 10px;">üìÑ Exportar SRT</button>

                    <div id="blocksInfo" style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; display: none;">
                        <strong>üìä Informa√ß√µes:</strong>
                        <div id="blocksStats"></div>
                    </div>
                </div>

                <!-- Preview dos blocos -->
                <div class="output-section">
                    <h2>üì¶ Blocos Gerados</h2>
                    <div id="blocksPreview" style="max-height: 600px; overflow-y: auto; background: white; border: 2px solid #ddd; border-radius: 8px; padding: 15px;">
                        <p style="color: #999;">Divida o roteiro para ver os blocos aqui.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Verificar autentica√ß√£o
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
            window.location.href = 'login.html';
        }

        // Bot√£o de logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        });

        // Fun√ß√£o para fazer requisi√ß√µes autenticadas
        function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'login.html';
                return Promise.reject('No token');
            }

            options.headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`
            };

            return fetch(url, options).then(res => {
                if (res.status === 401) {
                    // Token inv√°lido/expirado
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                    return Promise.reject('Unauthorized');
                }
                return res;
            });
        }

        const messages = document.getElementById('messages');
        const generateBtn = document.getElementById('generateBtn');
        const generateBtnText = document.getElementById('generateBtnText');
        const progress = document.getElementById('progress');
        const downloads = document.getElementById('downloads');
        const timer = document.getElementById('timer');
        const progressText = document.getElementById('progressText');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const charCounters = document.getElementById('charCounters');
        const roteiroChars = document.getElementById('roteiroChars');
        const totalCharsDisplay = document.getElementById('totalCharsDisplay');

        // Modo Autom√°tico no In√≠cio
        const modoAutomaticoInicio = document.getElementById('modoAutomaticoInicio');
        const configAutomatico = document.getElementById('configAutomatico');
        const modeloDocumentosInicio = document.getElementById('modeloDocumentosInicio');
        const modeloTakesInicio = document.getElementById('modeloTakesInicio');

        // Ferramentas
        const tools = document.getElementById('tools');
        const divideByCharsBtn = document.getElementById('divideByCharsBtn');
        const divideByWordsBtn = document.getElementById('divideByWordsBtn');
        const exportSrtBtn = document.getElementById('exportSrtBtn');
        const blocksPreview = document.getElementById('blocksPreview');
        const blocksInfo = document.getElementById('blocksInfo');
        const blocksStats = document.getElementById('blocksStats');

        // Ferramentas de IA
        const gerarTrilhaBtn = document.getElementById('gerarTrilhaBtn');
        const gerarPersonagensBtn = document.getElementById('gerarPersonagensBtn');
        const gerarTakesBtn = document.getElementById('gerarTakesBtn');
        const gerarTodosBtn = document.getElementById('gerarTodosBtn');
        const modeloDocumentos = document.getElementById('modeloDocumentos');
        const modoAutomatico = document.getElementById('modoAutomatico');
        const btnAutomaticoContainer = document.getElementById('btnAutomaticoContainer');
        const aiStatus = document.getElementById('aiStatus');
        const aiStatusText = document.getElementById('aiStatusText');

        let currentFiles = {};
        let currentBlocks = [];
        let currentPersonagens = null; // Objeto com personagens gerados
        let startTime = null;
        let timerInterval = null;
        const PAUSE_TIME = 0.9; // Pausa entre blocos em segundos

        // Fun√ß√£o para atualizar barra de progresso
        function updateProgress(percent, text) {
            progressBar.style.width = percent + '%';
            progressPercent.textContent = percent + '%';
            if (text) {
                progressText.textContent = text;
            }
        }

        // Fun√ß√£o para atualizar contadores de caracteres
        function updateCharCounters() {
            // Contar caracteres do roteiro
            let roteiroTotal = 0;
            if (currentFiles.hook) roteiroTotal += currentFiles.hook.length;
            if (currentFiles.topicos) {
                currentFiles.topicos.forEach(t => roteiroTotal += t.length);
            }

            // Contar caracteres de todos os documentos
            let docsTotal = roteiroTotal;
            if (currentFiles.estrutura) docsTotal += currentFiles.estrutura.length;
            if (currentFiles.trilha) docsTotal += currentFiles.trilha.length;
            if (currentFiles.personagens) docsTotal += currentFiles.personagens.length;
            if (currentFiles.takes) docsTotal += currentFiles.takes.length;

            roteiroChars.textContent = roteiroTotal.toLocaleString() + ' caracteres';
            totalCharsDisplay.textContent = docsTotal.toLocaleString() + ' caracteres';
            charCounters.style.display = 'block';
        }

        // Fun√ß√µes do cron√¥metro
        function startTimer() {
            startTime = Date.now();
            timer.style.display = 'inline';
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                timer.textContent = `‚è±Ô∏è ${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // Toggle Modo Autom√°tico no In√≠cio
        modoAutomaticoInicio.addEventListener('change', () => {
            if (modoAutomaticoInicio.checked) {
                configAutomatico.style.display = 'block';
                generateBtnText.textContent = 'üöÄ GERAR TUDO AUTOMATICAMENTE';
                generateBtn.style.background = 'linear-gradient(135deg, #00e676 0%, #00c853 100%)';
                generateBtn.style.color = '#000';
            } else {
                configAutomatico.style.display = 'none';
                generateBtnText.textContent = 'üöÄ Gerar Roteiro';
                generateBtn.style.background = '';
                generateBtn.style.color = '';
            }
        });

        function addMessage(label, content, type = 'assistant', data = {}) {
            const msg = document.createElement('div');
            msg.className = `message ${type}`;

            let statsHTML = '';
            if (data.charCount !== undefined) {
                statsHTML = `
                    <div class="message-stats">
                        <div>üìä <span>${data.charCount}</span> caracteres (com espa√ßos)</div>
                        <div>üìù <span>${data.charCountNoSpaces}</span> caracteres (sem espa√ßos)</div>
                        <div>üìñ <span>${data.wordCount}</span> palavras</div>
                    </div>
                `;
            }

            let promptHTML = '';
            if (data.prompt) {
                const promptId = `prompt-${Date.now()}-${Math.random()}`;
                promptHTML = `
                    <button class="prompt-toggle" onclick="document.getElementById('${promptId}').classList.toggle('visible')">
                        üëÅÔ∏è Ver Prompt Enviado
                    </button>
                    <div class="prompt-content" id="${promptId}">${data.prompt}</div>
                `;
            }

            let progressHTML = '';
            if (data.progress) {
                progressHTML = `<div style="margin-top: 8px; color: #667eea; font-weight: 600; font-size: 0.9rem;">‚è≥ ${data.progress}</div>`;
            }

            msg.innerHTML = `
                <div class="message-label">${label}</div>
                ${progressHTML}
                <div class="message-content">${content}</div>
                ${statsHTML}
                ${promptHTML}
            `;
            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;
        }

        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        generateBtn.addEventListener('click', async () => {
            messages.innerHTML = '';
            downloads.style.display = 'none';
            tools.style.display = 'none';
            progress.style.display = 'block';
            generateBtn.disabled = true;

            // Iniciar cron√¥metro
            startTimer();

            // Resetar progresso
            updateProgress(0, 'Iniciando...');

            currentFiles = {};
            currentBlocks = [];

            const input = {
                title: document.getElementById('title').value,
                synopsis: document.getElementById('synopsis').value,
                knowledgeBase: document.getElementById('knowledge').value,
                language: document.getElementById('language').value,
                numTopics: parseInt(document.getElementById('numTopics').value),
                numSubtopics: parseInt(document.getElementById('numSubtopics').value),
                hookChars: parseInt(document.getElementById('hookChars').value),
                totalChars: parseInt(document.getElementById('totalChars').value),
                model: document.getElementById('claudeModel').value
            };

            try {
                const response = await fetch('/api/gerar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(input)
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));

                            if (data.type === 'step') {
                                const progressText = data.progress || `üîÑ ${data.step} - ${data.status}`;
                                addMessage('Sistema', progressText, 'system', { progress: data.progress });

                                // Atualizar barra de progresso baseado no passo
                                if (data.step === 'estrutura') {
                                    updateProgress(10, 'Gerando estrutura...');
                                } else if (data.step === 'hook') {
                                    updateProgress(20, 'Gerando hook...');
                                }
                            } else if (data.type === 'message') {
                                let label;
                                if (data.step === 'estrutura') {
                                    label = 'üìã Estrutura';
                                } else if (data.step === 'hook') {
                                    label = 'üé£ Hook';
                                } else if (data.step && data.step.includes('subtopico')) {
                                    const match = data.step.match(/topico(\d+)_subtopico(\d+)/);
                                    if (match) {
                                        label = `üìù T√≥pico ${match[1]} - Subt√≥pico ${match[2]}`;
                                    } else {
                                        label = 'IA';
                                    }
                                } else if (data.step && data.step.startsWith('topico')) {
                                    label = `üìñ ${data.step.replace('topico', 'T√≥pico ')}`;
                                } else {
                                    label = 'IA';
                                }

                                addMessage(label, data.content, 'assistant', {
                                    prompt: data.prompt,
                                    charCount: data.charCount,
                                    charCountNoSpaces: data.charCountNoSpaces,
                                    wordCount: data.wordCount
                                });
                            } else if (data.type === 'topico_complete') {
                                const percent = data.percentComplete || 0;
                                const emoji = percent >= 100 ? '‚úÖ' : percent >= 80 ? '‚ö†Ô∏è' : '‚ùå';
                                addMessage('Sistema',
                                    `${emoji} T√≥pico ${data.topicoNum} completo: ${data.totalChars} chars de ${data.expectedChars} esperados (${percent}%)`,
                                    'system'
                                );

                                // Atualizar progresso: 20% a 70% distribu√≠do entre t√≥picos
                                const numTopics = parseInt(document.getElementById('numTopics').value);
                                const progressoParcial = 20 + (data.topicoNum / numTopics) * 50;
                                updateProgress(Math.round(progressoParcial), `T√≥pico ${data.topicoNum}/${numTopics} completo`);
                            } else if (data.type === 'complete') {
                                currentFiles = data.files;

                                // Se modo autom√°tico est√° ativo, continuar gerando documentos
                                // Atualizar contadores
                                updateCharCounters();

                                if (modoAutomaticoInicio.checked) {
                                    addMessage('Sistema', '‚úÖ Roteiro completo! Iniciando gera√ß√£o autom√°tica de documentos...', 'system');

                                    // Gerar documentos automaticamente
                                    await gerarDocumentosAutomaticamente();

                                    stopTimer();
                                    addMessage('Sistema', 'üéâ TUDO PRONTO! Roteiro + Documentos gerados!', 'system');

                                    // Atualizar contadores finais
                                    updateCharCounters();
                                } else {
                                    stopTimer();
                                    addMessage('Sistema', '‚úÖ Gera√ß√£o completa!', 'system');
                                }

                                downloads.style.display = 'block';
                                tools.style.display = 'block';
                            } else if (data.type === 'error') {
                                stopTimer();
                                addMessage('Erro', data.error, 'error');
                            }
                        }
                    }
                }
            } catch (error) {
                addMessage('Erro', error.message, 'error');
            }

            progress.style.display = 'none';
            generateBtn.disabled = false;
        });

        // Download buttons
        document.getElementById('downloadEstrutura').addEventListener('click', () => {
            downloadFile('01_Estrutura.txt', currentFiles.estrutura);
        });

        document.getElementById('downloadHook').addEventListener('click', () => {
            downloadFile('02_Hook.txt', currentFiles.hook);
        });

        document.getElementById('downloadTopico1').addEventListener('click', () => {
            downloadFile('03_Topico_1.txt', currentFiles.topicos[0]);
        });

        document.getElementById('downloadTopico2').addEventListener('click', () => {
            downloadFile('04_Topico_2.txt', currentFiles.topicos[1]);
        });

        document.getElementById('downloadTopico3').addEventListener('click', () => {
            downloadFile('05_Topico_3.txt', currentFiles.topicos[2]);
        });

        document.getElementById('downloadCompleto').addEventListener('click', () => {
            const completo = [
                currentFiles.hook,
                ...currentFiles.topicos
            ].join('\n\n');
            downloadFile('00_Roteiro_Completo.txt', completo);
        });

        // Bot√£o Download Tudo
        document.getElementById('downloadTudo').addEventListener('click', () => {
            if (!currentFiles.hook || !currentFiles.topicos) {
                alert('‚ùå Gere um roteiro primeiro!');
                return;
            }

            // Download de todos os arquivos gerados
            const arquivos = [];

            // Estrutura
            if (currentFiles.estrutura) {
                arquivos.push({ nome: '01_Estrutura.txt', conteudo: currentFiles.estrutura });
            }

            // Hook
            if (currentFiles.hook) {
                arquivos.push({ nome: '02_Hook.txt', conteudo: currentFiles.hook });
            }

            // T√≥picos
            if (currentFiles.topicos) {
                currentFiles.topicos.forEach((topico, i) => {
                    arquivos.push({ nome: `03_Topico_${i + 1}.txt`, conteudo: topico });
                });
            }

            // Roteiro Completo
            const completo = [currentFiles.hook, ...currentFiles.topicos].join('\n\n');
            arquivos.push({ nome: '00_Roteiro_Completo.txt', conteudo: completo });

            // Trilha
            if (currentFiles.trilha) {
                arquivos.push({ nome: '02_Trilha_Sonora.txt', conteudo: currentFiles.trilha });
            }

            // Personagens
            if (currentFiles.personagens) {
                arquivos.push({ nome: '04_Personagens_Descricoes.txt', conteudo: currentFiles.personagens });
            }

            // Blocos
            if (currentBlocks.length > 0) {
                const blocosTexto = currentBlocks.map((bloco, i) => `BLOCO ${i + 1}\n${bloco}`).join('\n\n');
                arquivos.push({ nome: 'blocos.txt', conteudo: blocosTexto });
            }

            // SRT (se houver blocos)
            if (currentBlocks.length > 0) {
                const readingRate = 12;
                const pauseTime = 0.9;
                let srtContent = '';
                let currentTime = 0;
                currentBlocks.forEach((block, index) => {
                    const text = block.trim();
                    if (!text) return;
                    const duration = text.length / readingRate;
                    const startTime = currentTime;
                    const endTime = currentTime + duration;
                    srtContent += `${index + 1}\n${formatSrtTimestamp(startTime)} --> ${formatSrtTimestamp(endTime)}\n${text}\n\n`;
                    currentTime = endTime + pauseTime;
                });
                if (srtContent.trim()) {
                    arquivos.push({ nome: 'roteiro.srt', conteudo: srtContent.trim() });
                }
            }

            // Takes
            if (currentFiles.takes) {
                arquivos.push({ nome: '05_Takes_Prompts.txt', conteudo: currentFiles.takes });
            }

            // Fazer download de todos
            arquivos.forEach((arquivo, index) => {
                setTimeout(() => {
                    downloadFile(arquivo.nome, arquivo.conteudo);
                }, index * 200); // Delay de 200ms entre cada download
            });

            alert(`‚úÖ Baixando ${arquivos.length} arquivos...`);
        });

        // Bot√£o Download JSON
        document.getElementById('downloadJSON').addEventListener('click', () => {
            if (!currentFiles.hook || !currentFiles.topicos) {
                alert('‚ùå Gere um roteiro primeiro!');
                return;
            }

            // Criar objeto JSON com toda a documenta√ß√£o
            const documentacao = {
                metadata: {
                    timestamp: new Date().toISOString(),
                    generator: 'Gerador Profissional de Roteiros',
                    version: '1.0'
                },
                input: {
                    title: document.getElementById('title').value,
                    synopsis: document.getElementById('synopsis').value,
                    numTopics: parseInt(document.getElementById('numTopics').value),
                    totalChars: parseInt(document.getElementById('totalChars').value)
                },
                roteiro: {
                    estrutura: currentFiles.estrutura || null,
                    hook: currentFiles.hook || null,
                    topicos: currentFiles.topicos || [],
                    completo: currentFiles.hook && currentFiles.topicos ?
                        [currentFiles.hook, ...currentFiles.topicos].join('\n\n') : null
                },
                documentos: {
                    trilha: currentFiles.trilha || null,
                    personagens: currentFiles.personagens || null,
                    personagensObj: currentPersonagens || null,
                    takes: currentFiles.takes || null
                },
                blocos: currentBlocks.length > 0 ? currentBlocks.map((bloco, i) => ({
                    numero: i + 1,
                    texto: bloco,
                    caracteres: bloco.length
                })) : null,
                estatisticas: {
                    totalCaracteresRoteiro: (currentFiles.hook?.length || 0) +
                        (currentFiles.topicos?.reduce((sum, t) => sum + t.length, 0) || 0),
                    totalCaracteresDocumentos: (currentFiles.estrutura?.length || 0) +
                        (currentFiles.hook?.length || 0) +
                        (currentFiles.topicos?.reduce((sum, t) => sum + t.length, 0) || 0) +
                        (currentFiles.trilha?.length || 0) +
                        (currentFiles.personagens?.length || 0) +
                        (currentFiles.takes?.length || 0),
                    numeroBlocos: currentBlocks.length,
                    numeroTopicos: currentFiles.topicos?.length || 0,
                    numeroPersonagens: currentPersonagens ? Object.keys(currentPersonagens).length : 0
                }
            };

            // Converter para JSON formatado
            const jsonContent = JSON.stringify(documentacao, null, 2);
            downloadFile('documentacao_completa.json', jsonContent);
            alert('‚úÖ JSON baixado com toda a documenta√ß√£o!');
        });

        // ============================================
        // IMPORT DE BLOCOS E GERA√á√ÉO DE TAKES
        // ============================================

        const blocosFileInput = document.getElementById('blocosFileInput');
        const personagensFileInput = document.getElementById('personagensFileInput');
        const importBlocosBtn = document.getElementById('importBlocosBtn');
        const importStatus = document.getElementById('importStatus');
        const importStatusText = document.getElementById('importStatusText');
        const importProgressBar = document.getElementById('importProgressBar');
        const importProgressPercent = document.getElementById('importProgressPercent');
        let importedBlocks = [];
        let importedPersonagens = {};

        // Fun√ß√£o para atualizar barra de progresso do import
        function updateImportProgress(percent) {
            importProgressBar.style.width = percent + '%';
            importProgressPercent.textContent = Math.round(percent) + '%';
        }

        // Habilitar bot√£o quando arquivo for selecionado
        blocosFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) {
                importBlocosBtn.disabled = true;
                return;
            }

            try {
                const text = await file.text();
                // Parsear blocos do formato "BLOCO 1\n...\n\nBLOCO 2\n..."
                const blocosMatch = text.split(/BLOCO \d+\n/).filter(b => b.trim());

                if (blocosMatch.length === 0) {
                    alert('‚ùå Arquivo inv√°lido! N√£o foram encontrados blocos no formato "BLOCO 1"');
                    importBlocosBtn.disabled = true;
                    return;
                }

                importedBlocks = blocosMatch.map(b => b.trim());
                importBlocosBtn.disabled = false;
                importStatusText.textContent = `${importedBlocks.length} blocos carregados`;
                importStatus.style.display = 'block';
            } catch (error) {
                alert('‚ùå Erro ao ler arquivo: ' + error.message);
                importBlocosBtn.disabled = true;
            }
        });

        // Processar arquivo de personagens (opcional)
        personagensFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) {
                importedPersonagens = {};
                return;
            }

            try {
                const text = await file.text();
                // Parsear formato: "1. NOME\n\ndescri√ß√£o...\n\n2. OUTRO_NOME\n\n..."
                const matches = text.split(/\n\d+\.\s+/);

                importedPersonagens = {};
                for (const match of matches) {
                    const trimmed = match.trim();
                    if (!trimmed) continue;

                    // Primeira linha √© o nome, resto √© a descri√ß√£o
                    const lines = trimmed.split('\n');
                    const nome = lines[0].trim();
                    const descricao = lines.slice(1).join('\n').trim();

                    if (nome && descricao) {
                        importedPersonagens[nome] = descricao;
                    }
                }

                const numPersonagens = Object.keys(importedPersonagens).length;
                if (numPersonagens > 0) {
                    importStatusText.textContent = `${importedBlocks.length} blocos + ${numPersonagens} personagens carregados`;
                    console.log(`‚úÖ ${numPersonagens} personagens importados:`, Object.keys(importedPersonagens));
                } else {
                    alert('‚ö†Ô∏è Nenhum personagem encontrado no arquivo. Verifique o formato.');
                }
            } catch (error) {
                alert('‚ùå Erro ao ler personagens: ' + error.message);
                importedPersonagens = {};
            }
        });

        // Gerar takes a partir dos blocos importados
        importBlocosBtn.addEventListener('click', async () => {
            if (importedBlocks.length === 0) {
                alert('‚ùå Nenhum bloco importado!');
                return;
            }

            importBlocosBtn.disabled = true;
            const modelo = document.getElementById('modeloTakesImport').value;
            const language = document.getElementById('language').value;

            try {
                // Resetar barra de progresso
                updateImportProgress(0);
                importStatusText.textContent = 'Iniciando gera√ß√£o de takes...';

                const BLOCOS_POR_GRUPO = 40;
                const numGrupos = Math.ceil(importedBlocks.length / BLOCOS_POR_GRUPO);
                let todosTakes = [];

                for (let g = 0; g < numGrupos; g++) {
                    const inicio = g * BLOCOS_POR_GRUPO;
                    const fim = Math.min(inicio + BLOCOS_POR_GRUPO, importedBlocks.length);
                    const blocosGrupo = importedBlocks.slice(inicio, fim);

                    // Atualizar progresso (0% a 90% durante gera√ß√£o)
                    const progressoAtual = (g / numGrupos) * 90;
                    updateImportProgress(progressoAtual);
                    importStatusText.textContent = `Gerando takes ${inicio+1}-${fim} de ${importedBlocks.length} (grupo ${g+1}/${numGrupos})...`;

                    const takesRes = await fetch('/api/gerar-takes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            blocos: blocosGrupo,
                            personagens: importedPersonagens, // Usa personagens importados (ou {} se n√£o houver)
                            modelo: modelo,
                            offset: inicio,
                            language
                        })
                    });

                    const takesData = await takesRes.json();
                    if (takesData.error) {
                        throw new Error(takesData.error);
                    }

                    todosTakes.push(takesData.takesCompleto);
                }

                // Finalizando
                updateImportProgress(95);
                importStatusText.textContent = 'Compilando takes...';

                const takesCompleto = todosTakes.join('\n\n');
                currentFiles.takes = takesCompleto;
                downloadFile('05_Takes_Prompts_Importados.txt', takesCompleto);

                // Completo!
                updateImportProgress(100);
                importStatusText.textContent = `‚úÖ ${importedBlocks.length} takes gerados e baixados!`;
                alert(`‚úÖ Takes gerados com sucesso!\n\nTotal: ${importedBlocks.length} takes\nArquivo: 05_Takes_Prompts_Importados.txt`);

            } catch (error) {
                updateImportProgress(0);
                importStatusText.textContent = '‚ùå Erro: ' + error.message;
                alert('‚ùå Erro ao gerar takes: ' + error.message);
            } finally {
                importBlocosBtn.disabled = false;
            }
        });

        // ============================================
        // FERRAMENTAS DE MANIPULA√á√ÉO
        // ============================================

        function getFullScript() {
            if (!currentFiles.hook || !currentFiles.topicos) {
                alert('‚ùå Gere um roteiro primeiro!');
                return null;
            }
            return [currentFiles.hook, ...currentFiles.topicos].join('\n\n');
        }

        function displayBlocks(blocks) {
            currentBlocks = blocks;
            let html = '';
            blocks.forEach((block, i) => {
                const chars = block.length;
                const words = block.split(/\s+/).filter(w => w.length > 0).length;
                html += `
                    <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-left: 4px solid #667eea; border-radius: 4px;">
                        <div style="font-weight: bold; color: #667eea; margin-bottom: 5px;">
                            üì¶ Bloco ${i + 1} | ${chars} chars | ${words} palavras
                        </div>
                        <div style="white-space: pre-wrap; color: #333;">${block}</div>
                    </div>
                `;
            });
            blocksPreview.innerHTML = html;

            // Mostrar estat√≠sticas
            const totalChars = blocks.reduce((sum, b) => sum + b.length, 0);
            const totalWords = blocks.reduce((sum, b) => sum + b.split(/\s+/).filter(w => w.length > 0).length, 0);
            blocksInfo.style.display = 'block';
            blocksStats.innerHTML = `
                <div>üì¶ <strong>${blocks.length}</strong> blocos gerados</div>
                <div>üìä <strong>${totalChars}</strong> caracteres totais</div>
                <div>üìù <strong>${totalWords}</strong> palavras totais</div>
            `;
        }

        // Dividir por caracteres
        divideByCharsBtn.addEventListener('click', () => {
            const text = getFullScript();
            if (!text) return;

            const maxChars = parseInt(document.getElementById('blockChars').value) || 490;

            // Dividir texto em senten√ßas (por ponto final, exclama√ß√£o, interroga√ß√£o)
            const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
            const blocks = [];
            let currentBlock = '';

            for (const sentence of sentences) {
                const trimmed = sentence.trim();
                if (!trimmed) continue;

                // Se adicionar a senten√ßa ultrapassar o limite e j√° temos conte√∫do, criar novo bloco
                if (currentBlock.length + trimmed.length + 1 > maxChars && currentBlock.length > 0) {
                    blocks.push(currentBlock.trim());
                    currentBlock = trimmed;
                } else {
                    currentBlock += (currentBlock.length > 0 ? ' ' : '') + trimmed;
                }
            }

            // Adicionar √∫ltimo bloco se houver
            if (currentBlock.trim().length > 0) {
                blocks.push(currentBlock.trim());
            }

            displayBlocks(blocks);
        });

        // Dividir por palavras
        divideByWordsBtn.addEventListener('click', () => {
            const text = getFullScript();
            if (!text) return;

            const wordsPerBlock = parseInt(document.getElementById('blockWords').value) || 17;

            // Dividir texto em senten√ßas
            const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
            const blocks = [];
            let currentBlock = '';
            let currentWordCount = 0;

            for (const sentence of sentences) {
                const trimmed = sentence.trim();
                if (!trimmed) continue;

                const sentenceWords = trimmed.split(/\s+/).filter(w => w.length > 0).length;

                // Se adicionar a senten√ßa ultrapassar o limite e j√° temos palavras, criar novo bloco
                if (currentWordCount + sentenceWords > wordsPerBlock && currentWordCount > 0) {
                    blocks.push(currentBlock.trim());
                    currentBlock = trimmed;
                    currentWordCount = sentenceWords;
                } else {
                    currentBlock += (currentBlock.length > 0 ? ' ' : '') + trimmed;
                    currentWordCount += sentenceWords;
                }
            }

            // Adicionar √∫ltimo bloco se houver
            if (currentBlock.trim().length > 0) {
                blocks.push(currentBlock.trim());
            }

            displayBlocks(blocks);
        });

        // Exportar SRT
        exportSrtBtn.addEventListener('click', () => {
            if (currentBlocks.length === 0) {
                alert('‚ùå Divida o roteiro em blocos primeiro!');
                return;
            }

            const readingRate = parseInt(document.getElementById('readingRate').value) || 12;
            const pauseTime = PAUSE_TIME; // 0.9 segundos

            let srtContent = '';
            let currentTime = 0;

            currentBlocks.forEach((block, index) => {
                const text = block.trim();
                if (!text) return;

                // Calcular dura√ß√£o baseado no reading rate (caracteres por segundo)
                const duration = text.length / readingRate;
                const startTime = currentTime;
                const endTime = currentTime + duration;

                // Formatar timestamps no formato SRT (HH:MM:SS,mmm)
                const startTimestamp = formatSrtTimestamp(startTime);
                const endTimestamp = formatSrtTimestamp(endTime);

                // Adicionar entrada SRT
                srtContent += `${index + 1}\n`;
                srtContent += `${startTimestamp} --> ${endTimestamp}\n`;
                srtContent += `${text}\n\n`;

                // Avan√ßar tempo (adicionar pausa entre blocos)
                currentTime = endTime + pauseTime;
            });

            // Download do arquivo SRT
            const blob = new Blob([srtContent.trim()], { type: 'text/srt;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'roteiro.srt';
            a.click();
            URL.revokeObjectURL(url);

            alert(`‚úÖ Arquivo SRT gerado com ${currentBlocks.length} blocos!`);
        });

        // Formatar timestamp no formato SRT (HH:MM:SS,mmm)
        function formatSrtTimestamp(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            const milliseconds = Math.floor((totalSeconds % 1) * 1000);

            return `${pad2(hours)}:${pad2(minutes)}:${pad2(seconds)},${pad3(milliseconds)}`;
        }

        function pad2(n) {
            return String(n).padStart(2, '0');
        }

        function pad3(n) {
            return String(n).padStart(3, '0');
        }

        // ============================================
        // FERRAMENTAS DE IA
        // ============================================

        function showAiStatus(message) {
            aiStatus.style.display = 'block';
            aiStatusText.textContent = message;
        }

        function hideAiStatus() {
            aiStatus.style.display = 'none';
        }

        // Gerar Trilha Sonora
        gerarTrilhaBtn.addEventListener('click', async () => {
            const roteiro = getFullScript();
            if (!roteiro) return;

            gerarTrilhaBtn.disabled = true;
            showAiStatus('Gerando trilha sonora... Aguarde ~10 segundos');

            try {
                const modelo = modeloDocumentos.value;
                const language = document.getElementById('language').value;
                const response = await fetch('/api/gerar-trilha', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roteiro, modelo, language })
                });

                const data = await response.json();

                if (data.error) {
                    alert(`‚ùå Erro: ${data.error}`);
                } else {
                    currentFiles.trilha = data.trilha;
                    downloadFile('02_Trilha_Sonora.txt', data.trilha);
                    showAiStatus(`‚úÖ Trilha sonora gerada! Custo: ~$${data.custoEstimado}`);
                    setTimeout(hideAiStatus, 5000);
                }
            } catch (error) {
                alert(`‚ùå Erro: ${error.message}`);
                hideAiStatus();
            }

            gerarTrilhaBtn.disabled = false;
        });

        // Gerar Personagens
        gerarPersonagensBtn.addEventListener('click', async () => {
            const roteiro = getFullScript();
            if (!roteiro) return;

            gerarPersonagensBtn.disabled = true;
            showAiStatus('Gerando descri√ß√µes de personagens... Aguarde ~15 segundos');

            try {
                const modelo = modeloDocumentos.value;
                const response = await fetch('/api/gerar-personagens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roteiro, modelo })
                });

                const data = await response.json();

                if (data.error) {
                    alert(`‚ùå Erro: ${data.error}`);
                } else {
                    currentFiles.personagens = data.personagensTexto;
                    currentPersonagens = data.personagensObj;

                    // Habilitar bot√£o de takes
                    gerarTakesBtn.disabled = false;
                    gerarTakesBtn.title = 'Gerar prompts de imagem para cada bloco';

                    downloadFile('04_Personagens_Descricoes.txt', data.personagensTexto);
                    showAiStatus(`‚úÖ ${data.numPersonagens} personagens gerados! Custo: ~$${data.custoEstimado}`);
                    setTimeout(hideAiStatus, 5000);
                }
            } catch (error) {
                alert(`‚ùå Erro: ${error.message}`);
                hideAiStatus();
            }

            gerarPersonagensBtn.disabled = false;
        });

        // Gerar Takes
        gerarTakesBtn.addEventListener('click', async () => {
            // Se n√£o tiver blocos, dividir automaticamente
            if (currentBlocks.length === 0) {
                const roteiro = getFullScript();
                if (!roteiro) return;

                showAiStatus('Dividindo roteiro em blocos automaticamente...');
                await dividirBlocosAutomaticamente(roteiro);
            }

            if (!currentPersonagens) {
                alert('‚ùå Gere os personagens primeiro!');
                return;
            }

            gerarTakesBtn.disabled = true;
            showAiStatus(`Gerando ${currentBlocks.length} takes... Aguarde ~20 segundos`);

            try {
                const modelo = modeloDocumentos.value;
                const response = await fetch('/api/gerar-takes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        blocos: currentBlocks,
                        personagens: currentPersonagens,
                        modelo
                    })
                });

                const data = await response.json();

                if (data.error) {
                    alert(`‚ùå Erro: ${data.error}`);
                } else {
                    currentFiles.takes = data.takesCompleto;
                    downloadFile('05_Takes_Prompts.txt', data.takesCompleto);
                    showAiStatus(`‚úÖ ${data.numTakes} takes gerados! Custo: ~$${data.custoEstimado}`);
                    setTimeout(hideAiStatus, 5000);
                }
            } catch (error) {
                alert(`‚ùå Erro: ${error.message}`);
                hideAiStatus();
            }

            gerarTakesBtn.disabled = false;
        });

        // ============================================
        // MODO AUTOM√ÅTICO
        // ============================================

        // Toggle do bot√£o autom√°tico
        modoAutomatico.addEventListener('change', () => {
            btnAutomaticoContainer.style.display = modoAutomatico.checked ? 'block' : 'none';
        });

        // Fun√ß√£o para dividir blocos automaticamente
        async function dividirBlocosAutomaticamente(texto) {
            const maxChars = parseInt(document.getElementById('blockCharsConfig').value) || 490;

            const sentences = texto.match(/[^.!?]+[.!?]+/g) || [texto];
            const blocks = [];
            let currentBlock = '';

            for (const sentence of sentences) {
                const trimmed = sentence.trim();
                if (!trimmed) continue;

                if (currentBlock.length + trimmed.length + 1 > maxChars && currentBlock.length > 0) {
                    blocks.push(currentBlock.trim());
                    currentBlock = trimmed;
                } else {
                    currentBlock += (currentBlock.length > 0 ? ' ' : '') + trimmed;
                }
            }

            if (currentBlock.trim().length > 0) {
                blocks.push(currentBlock.trim());
            }

            displayBlocks(blocks);
            return blocks;
        }

        // Fun√ß√£o para gerar documentos automaticamente (chamada ap√≥s gerar roteiro)
        async function gerarDocumentosAutomaticamente() {
            const roteiro = getFullScript();
            if (!roteiro) return;

            const modelo = modeloDocumentosInicio.value;
            const modeloTakes = modeloTakesInicio.value;

            try {
                // PASSO 1: Dividir em blocos
                updateProgress(70, 'üìê Dividindo roteiro em blocos...');
                addMessage('Sistema', '[üìê 1/5] Dividindo roteiro em blocos...', 'system');
                await dividirBlocosAutomaticamente(roteiro);

                // Download blocos.txt
                const blocosTexto = currentBlocks.map((bloco, i) => `BLOCO ${i + 1}\n${bloco}`).join('\n\n');
                downloadFile('blocos.txt', blocosTexto);

                await new Promise(resolve => setTimeout(resolve, 500));

                // PASSO 2: Gerar Trilha
                updateProgress(75, 'üéµ Gerando trilha sonora...');
                addMessage('Sistema', '[üéµ 2/5] Gerando trilha sonora... (~10s)', 'system');
                const language = document.getElementById('language').value;
                const trilhaRes = await fetch('/api/gerar-trilha', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roteiro, modelo, language })
                });
                const trilhaData = await trilhaRes.json();
                if (trilhaData.error) throw new Error(trilhaData.error);
                currentFiles.trilha = trilhaData.trilha;

                // Mostrar conte√∫do gerado
                addMessage('üéµ Trilha Sonora', trilhaData.trilha, 'assistant', {
                    charCount: trilhaData.trilha.length,
                    charCountNoSpaces: trilhaData.trilha.replace(/\s/g, '').length,
                    wordCount: trilhaData.trilha.split(/\s+/).filter(w => w.length > 0).length
                });

                downloadFile('02_Trilha_Sonora.txt', trilhaData.trilha);
                addMessage('Sistema', `‚úÖ Trilha sonora gerada! (~$${trilhaData.custoEstimado})`, 'system');
                updateCharCounters();

                // PASSO 3: Gerar Personagens
                updateProgress(80, 'üë• Gerando personagens...');
                addMessage('Sistema', '[üë• 3/5] Gerando personagens... (~15s)', 'system');
                const persRes = await fetch('/api/gerar-personagens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roteiro, modelo, language })
                });
                const persData = await persRes.json();
                if (persData.error) throw new Error(persData.error);
                currentFiles.personagens = persData.personagensTexto;
                currentPersonagens = persData.personagensObj;

                // Mostrar conte√∫do gerado
                addMessage('üë• Personagens', persData.personagensTexto, 'assistant', {
                    charCount: persData.personagensTexto.length,
                    charCountNoSpaces: persData.personagensTexto.replace(/\s/g, '').length,
                    wordCount: persData.personagensTexto.split(/\s+/).filter(w => w.length > 0).length
                });

                downloadFile('04_Personagens_Descricoes.txt', persData.personagensTexto);
                addMessage('Sistema', `‚úÖ ${persData.numPersonagens} personagens gerados! (~$${persData.custoEstimado})`, 'system');

                // Habilitar bot√£o de takes manual
                gerarTakesBtn.disabled = false;
                gerarTakesBtn.title = 'Gerar prompts de imagem para cada bloco';

                updateCharCounters();

                // PASSO 4: Gerar SRT
                updateProgress(85, 'üìÑ Gerando SRT...');
                addMessage('Sistema', '[üìÑ 4/5] Gerando SRT... (~2s)', 'system');
                const readingRate = parseInt(document.getElementById('readingRateConfig').value) || 12;
                const pauseTime = 0.9;
                let srtContent = '';
                let currentTime = 0;
                currentBlocks.forEach((block, index) => {
                    const text = block.trim();
                    if (!text) return;
                    const duration = text.length / readingRate;
                    const startTime = currentTime;
                    const endTime = currentTime + duration;
                    srtContent += `${index + 1}\n${formatSrtTimestamp(startTime)} --> ${formatSrtTimestamp(endTime)}\n${text}\n\n`;
                    currentTime = endTime + pauseTime;
                });
                downloadFile('roteiro.srt', srtContent.trim());
                addMessage('Sistema', `‚úÖ SRT gerado com ${currentBlocks.length} blocos!`, 'system');

                // PASSO 5: Gerar Takes (em grupos de 40 - otimizado custo vs seguran√ßa)
                const BLOCOS_POR_GRUPO = 40;
                const numGrupos = Math.ceil(currentBlocks.length / BLOCOS_POR_GRUPO);
                let todosTakes = [];
                let ultimoCustoTakes = '0.025';

                for (let g = 0; g < numGrupos; g++) {
                    const inicio = g * BLOCOS_POR_GRUPO;
                    const fim = Math.min(inicio + BLOCOS_POR_GRUPO, currentBlocks.length);
                    const blocosGrupo = currentBlocks.slice(inicio, fim);

                    // Atualizar progresso: 85% a 100% distribu√≠do entre os grupos
                    const progressoParcial = 85 + ((g + 1) / numGrupos) * 15;
                    updateProgress(Math.round(progressoParcial), `üé¨ Gerando takes ${inicio+1}-${fim}...`);
                    addMessage('Sistema', `[üé¨ 5/5 - Grupo ${g+1}/${numGrupos}] Gerando takes ${inicio+1}-${fim}... (~20s)`, 'system');

                    const takesRes = await fetch('/api/gerar-takes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            blocos: blocosGrupo,
                            personagens: currentPersonagens,
                            modelo: modeloTakes,
                            offset: inicio,
                            language
                        })
                    });
                    const takesData = await takesRes.json();
                    if (takesData.error) {
                        addMessage('Erro', `Erro no grupo ${g+1}: ${takesData.error}`, 'error');
                        throw new Error(takesData.error);
                    }

                    // Mostrar preview dos takes gerados (primeiros 500 chars)
                    const preview = takesData.takesCompleto.substring(0, 500) + '...';
                    addMessage(`üé¨ Takes ${inicio+1}-${fim}`, preview, 'assistant', {
                        charCount: takesData.takesCompleto.length
                    });

                    todosTakes.push(takesData.takesCompleto);
                    ultimoCustoTakes = takesData.custoEstimado;
                    addMessage('Sistema', `‚úÖ Takes ${inicio+1}-${fim} gerados! (${takesData.numTakes} takes)`, 'system');
                    updateCharCounters();
                }

                const takesCompleto = todosTakes.join('\n\n');
                currentFiles.takes = takesCompleto;
                downloadFile('05_Takes_Prompts.txt', takesCompleto);
                addMessage('Sistema', `‚úÖ Total: ${currentBlocks.length} takes gerados!`, 'system');

                // Sucesso!
                updateProgress(100, '‚úÖ COMPLETO!');
                const custoTotal = (parseFloat(trilhaData.custoEstimado) +
                                   parseFloat(persData.custoEstimado) +
                                   (parseFloat(ultimoCustoTakes) * numGrupos)).toFixed(3);
                addMessage('Sistema', `üí∞ Custo dos documentos: ~$${custoTotal}`, 'system');

            } catch (error) {
                addMessage('Erro', `Erro ao gerar documentos: ${error.message}`, 'error');
            }
        }

        // Gerar Todos os Documentos (Modo Autom√°tico)
        gerarTodosBtn.addEventListener('click', async () => {
            const roteiro = getFullScript();
            if (!roteiro) return;

            const modelo = modeloDocumentos.value;

            // Desabilitar todos os bot√µes
            gerarTodosBtn.disabled = true;
            gerarTrilhaBtn.disabled = true;
            gerarPersonagensBtn.disabled = true;
            gerarTakesBtn.disabled = true;

            try {
                // PASSO 1: Dividir em blocos
                showAiStatus('[1/4] Dividindo roteiro em blocos...');
                await dividirBlocosAutomaticamente(roteiro);
                await new Promise(resolve => setTimeout(resolve, 500));

                // PASSO 2: Gerar Trilha
                showAiStatus('[2/4] Gerando trilha sonora... (~10s)');
                const language = document.getElementById('language').value;
                const trilhaRes = await fetch('/api/gerar-trilha', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roteiro, modelo, language })
                });
                const trilhaData = await trilhaRes.json();
                if (trilhaData.error) throw new Error(trilhaData.error);
                currentFiles.trilha = trilhaData.trilha;
                downloadFile('02_Trilha_Sonora.txt', trilhaData.trilha);

                // PASSO 3: Gerar Personagens
                showAiStatus('[3/4] Gerando personagens... (~15s)');
                const persRes = await fetch('/api/gerar-personagens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roteiro, modelo, language })
                });
                const persData = await persRes.json();
                if (persData.error) throw new Error(persData.error);
                currentFiles.personagens = persData.personagensTexto;
                currentPersonagens = persData.personagensObj;
                downloadFile('04_Personagens_Descricoes.txt', persData.personagensTexto);

                // PASSO 4: Gerar Takes
                showAiStatus('[4/4] Gerando takes... (~20s)');
                const takesRes = await fetch('/api/gerar-takes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        blocos: currentBlocks,
                        personagens: currentPersonagens,
                        modelo,
                        language
                    })
                });
                const takesData = await takesRes.json();
                if (takesData.error) throw new Error(takesData.error);
                currentFiles.takes = takesData.takesCompleto;
                downloadFile('05_Takes_Prompts.txt', takesData.takesCompleto);

                // Sucesso!
                const custoTotal = (parseFloat(trilhaData.custoEstimado) +
                                   parseFloat(persData.custoEstimado) +
                                   parseFloat(takesData.custoEstimado)).toFixed(3);
                showAiStatus(`‚úÖ Todos os documentos gerados! Custo total: ~$${custoTotal}`);
                setTimeout(hideAiStatus, 7000);

                // Habilitar bot√£o de takes
                gerarTakesBtn.disabled = false;
                gerarTakesBtn.title = 'Gerar prompts de imagem para cada bloco';

            } catch (error) {
                alert(`‚ùå Erro: ${error.message}`);
                hideAiStatus();
            }

            // Reabilitar bot√µes
            gerarTodosBtn.disabled = false;
            gerarTrilhaBtn.disabled = false;
            gerarPersonagensBtn.disabled = false;
        });
    </script>
</body>
</html>
